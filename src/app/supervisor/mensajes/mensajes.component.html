<div class="mensajes-layout">
  
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Atención a Clientes</h3>
    </div>
    
    @if (loading()) {
      <app-loading-spinner />
    } @else {
      <div class="lista-conversaciones">
        @for (conv of conversaciones(); track conv.id_conversacion) {
          <div class="conv-item" 
               [class.active]="conversacionSeleccionada()?.id_conversacion === conv.id_conversacion"
               (click)="seleccionar(conv)">
            
            <div class="avatar-circle">
              {{ conv.cliente?.nombre_empresa?.charAt(0) || 'C' }}
            </div>
            
            <div class="conv-info">
              <div class="conv-top">
                <span class="conv-title">{{ conv.cliente?.nombre_empresa }}</span>
                <span class="conv-date">
                  {{ (conv.ultimo_mensaje?.creado_en || conv.creado_en) | date:'shortTime' }}
                </span>
              </div>
              <div class="conv-preview">
                <span class="text-xs text-gray-500 mr-1">
                  {{ conv.ultimo_mensaje?.emisor_tipo === 'SUPERVISOR' ? 'Tú:' : conv.cliente?.nombre + ':' }}
                </span>
                {{ conv.ultimo_mensaje?.contenido || 'Nueva conversación' }}
              </div>
            </div>
          </div>
        }
        @if (conversaciones().length === 0) {
          <app-empty-state mensaje="No hay conversaciones activas." />
        }
      </div>
    }
  </div>

  <div class="chat-area">
    @if (!conversacionSeleccionada()) {
      <div class="chat-placeholder">
        <app-icon name="message-square" [size]="48" class="text-gray-300 mb-4"></app-icon>
        <p>Selecciona un cliente para ver el historial</p>
      </div>
    } @else {
      <div class="chat-header">
        <div class="header-info">
          <h3>{{ conversacionSeleccionada()?.cliente?.nombre_empresa }}</h3>
          <span class="subtitle">Contacto: {{ conversacionSeleccionada()?.cliente?.nombre }}</span>
        </div>
        <div class="header-actions">
        </div>
      </div>

      <div class="messages-viewport" #chatViewport>
        @for (msg of mensajes(); track msg.id_mensaje) {
          <div class="msg-row"
               [ngClass]="{
                 'me': esPropio(msg),
                 'client': esCliente(msg),
                 'auditor': (!esPropio(msg) && !esCliente(msg))
               }">
            <div class="msg-bubble">
              <p>{{ msg.contenido }}</p>
              <span class="msg-time">{{ msg.creado_en | date:'shortTime' }}</span>
            </div>
          </div>
        }
      </div>

      <div class="chat-input-area">
        <input 
          type="text" 
          [(ngModel)]="textoMensaje" 
          (keyup.enter)="enviar()"
          placeholder="Responder al cliente..."
        />
        <button class="btn-send" (click)="enviar()" [disabled]="!textoMensaje.trim()">
          <app-icon name="send"></app-icon>
        </button>
      </div>
    }
  </div>
</div>