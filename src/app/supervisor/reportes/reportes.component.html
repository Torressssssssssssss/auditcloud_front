<div class="reportes-page">
  <div class="page-header">
    <h2>Reportes Finales</h2>
    <button class="btn btn-primary" (click)="showForm.set(!showForm())">
      {{ showForm() ? 'Cancelar' : '+ Subir Reporte Final' }}
    </button>
  </div>

  @if (showForm()) {
    <div class="form-card mb-4 slide-in">
      <h3>Cargar Documento Final</h3>
      <p class="text-sm text-gray-500 mb-4">
        <app-icon name="alert-circle" [size]="14"></app-icon> 
        Atención: Esta acción finalizará la auditoría seleccionada.
      </p>

      <form [formGroup]="reporteForm" (ngSubmit)="onSubmit()">
        <div class="form-grid">
          
          <div class="form-group">
            <label>Auditoría</label>
            <select formControlName="id_auditoria">
              <option value="">Selecciona una auditoría...</option>
              @for (audit of auditoriasPendientes(); track audit.id_auditoria) {
                <option [value]="audit.id_auditoria" [disabled]="audit.id_estado === 3">
                  #{{ audit.id_auditoria }} - {{ audit.cliente?.nombre_empresa }} 
                  {{ audit.id_estado === 3 ? '(Finalizada)' : '' }}
                </option>
              }
            </select>
          </div>

          <div class="form-group">
            <label>Nombre del Reporte</label>
            <input type="text" formControlName="nombre" placeholder="Ej. Reporte Final 2024">
          </div>

          <div class="form-group full-width">
            <label>Archivo PDF</label>
            <input type="file" #fileInput (change)="onFileSelect($event)" accept="application/pdf">
            <span class="text-xs text-gray-500">Solo archivos .pdf</span>
          </div>
        </div>

        <div class="form-actions mt-4 flex justify-end">
          <button type="submit" class="btn btn-success" 
            [disabled]="reporteForm.invalid || !selectedFile || enviando()">
            {{ enviando() ? 'Subiendo...' : 'Finalizar y Guardar' }}
          </button>
        </div>
      </form>
    </div>
  }

  <div class="filters mb-4">
    <div class="filter-group">
      <label>Filtrar historial:</label>
      <select [value]="filtroAuditoria() ?? ''" (change)="onAuditoriaChange($event)">
        <option value="">Todas las auditorías</option>
        @for (audit of auditoriasPendientes(); track audit.id_auditoria) {
          <option [value]="audit.id_auditoria">#{{ audit.id_auditoria }}</option>
        }
      </select>
    </div>
  </div>

  @if (loading()) {
    <app-loading-spinner />
  } @else if (reportesFiltrados.length === 0) {
    <app-empty-state mensaje="No hay reportes generados." />
  } @else {
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Auditoría</th>
            <th>Cliente</th>
            <th>Documento</th>
            <th>Fecha Entrega</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (rep of reportesFiltrados; track rep.id_reporte) {
            <tr>
              <td><span class="font-bold">#{{ rep.id_auditoria }}</span></td>
              <td>{{ rep.nombre_cliente || 'N/A' }}</td>
              <td>
                <div class="flex items-center gap-2">
                  <app-icon name="file-text" [size]="16" class="text-red-500"></app-icon>
                  {{ rep.nombre }}
                </div>
              </td>
              <td>{{ rep.fecha_creacion | date:'mediumDate' }}</td>
              <td>
                <button class="btn btn-sm btn-secondary" (click)="descargarReporte(rep.url)">
                  <app-icon name="download" [size]="16"></app-icon> Descargar
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>