<div class="mensajes-layout">
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Mensajes</h3>
    </div>

    @if (loading()) {
      <app-loading-spinner />
    } @else {
      <div class="conversaciones-list" #chatNav>
        @for (conv of conversaciones(); track conv.id_conversacion) {
          <div class="conv-item"
               [class.active]="conversacionSeleccionada()?.id_conversacion === conv.id_conversacion"
               (click)="seleccionarConversacion(conv)">

            <div class="conv-avatar">
              {{ conv.empresa?.nombre?.charAt(0) || 'E' }}
            </div>

            <div class="conv-info">
              <div class="conv-top">
                <span class="conv-name">{{ conv.empresa?.nombre }}</span>
                <span class="conv-date">
                  {{ (conv.ultimo_mensaje?.creado_en || conv.creado_en) | date:'shortTime' }}
                </span>
              </div>
              <div class="conv-preview">
                <span class="conv-from" *ngIf="conv.ultimo_mensaje">{{ conv.ultimo_mensaje.emisor_tipo === 'CLIENTE' ? 'Tú:' : conv.ultimo_mensaje.emisor_tipo + ':' }}</span>
                {{ conv.ultimo_mensaje?.contenido || 'Iniciar conversación' }}
              </div>
            </div>
          </div>
        }
        @if (conversaciones().length === 0) {
          <app-empty-state mensaje="No hay conversaciones iniciadas." />
        }
      </div>
    }
  </div>

  <div class="chat-area">
    @if (!conversacionSeleccionada()) {
      <div class="chat-placeholder">
        <app-icon name="message-square" [size]="48" class="text-gray-300 mb-4"></app-icon>
        <p>Selecciona un chat para comenzar</p>
      </div>
    } @else {
      <div class="chat-header">
        <div class="header-info">
          <h3>{{ conversacionSeleccionada()?.empresa?.nombre }}</h3>
          <span class="subtitle">Empresa auditada</span>
        </div>
      </div>

      <div class="messages-viewport" #chatContainer>
        @for (msg of mensajes(); track msg.id_mensaje) {
          @if (esSolicitudPago(msg)) {
            <div class="msg-system">
              <div class="system-card">
                <app-icon name="credit-card"></app-icon>
                <span>{{ msg.contenido }}</span>
                <a [routerLink]="['/cliente/pagos']" class="btn-link">Ir a pagos</a>
              </div>
            </div>
          } @else {
            <div class="msg-row"
                 [ngClass]="{
                   'me': esPropio(msg),
                   'supervisor': esSupervisor(msg),
                   'auditor': esAuditor(msg)
                 }">
              <div class="msg-bubble">
                <p>{{ msg.contenido }}</p>
                <span class="msg-time">{{ msg.creado_en | date:'shortTime' }}</span>
              </div>
            </div>
          }
        }
      </div>

      <div class="chat-input-area">
        <input
          type="text"
          [(ngModel)]="textoMensaje"
          (keyup.enter)="enviarMensaje()"
          placeholder="Escribe un mensaje..."
        />
        <button class="btn-send" (click)="enviarMensaje()" [disabled]="!textoMensaje.trim()">
          <app-icon name="send"></app-icon>
        </button>
      </div>
    }
  </div>
</div>