<div class="detalle-page">
  @if (loading()) {
    <app-loading-spinner />
  } @else if (!auditoria()) {
    <app-empty-state mensaje="Auditoría no encontrada" />
  } @else {
    <div class="page-header">
      <div>
        <button class="btn btn-secondary" (click)="router.navigate(['/auditor/auditorias'])">
          ← Volver
        </button>
        <h2>Auditoría #{{ auditoria()!.id_auditoria }}</h2>
      </div>
      <app-status-badge [estado]="auditoria()!.id_estado" tipo="auditoria" />
    </div>

    <div class="detalle-grid">
      <div class="info-card">
        <h3>Información General</h3>
        <div class="info-item">
          <label>Cliente:</label>
          <span>{{ auditoria()!.cliente?.nombre_empresa || auditoria()!.cliente?.nombre || 'N/A' }}</span>
        </div>
        <div class="info-item">
          <label>Objetivo:</label>
          <span>{{ auditoria()!.objetivo || 'No especificado' }}</span>
        </div>
        <div class="info-item">
          <label>Estado:</label>
          <span>{{ getEstadoNombre(auditoria()!.id_estado) }}</span>
        </div>
        <div class="info-item">
          <label>Fecha Creación:</label>
          <span>{{ auditoria()!.fecha_creacion ? (auditoria()!.fecha_creacion | date:'short') : 'No iniciada' }}</span>
        </div>
      </div>

      <div class="info-card">
        <h3>Módulos Asignados</h3>
        <div class="modulos-list">
            @if (auditoria()!.modulos && auditoria()!.modulos!.length > 0) {
            @for (modulo of auditoria()!.modulos; track modulo) {
              <span class="modulo-tag">{{ getModuloNombre(modulo) }}</span>
            }
          } @else {
            <p class="text-muted">No hay módulos asignados</p>
          }
        </div>
      </div>

      <div class="info-card">
        <h3>Objetivo</h3>
        @if (!isEditingObjetivo()) {
          <p class="objetivo-text">
            {{ auditoria()?.objetivo || 'No especificado' }}
          </p>

          <div class="quick-actions">
            <button class="btn btn-primary" (click)="startEditObjetivo()">
              {{ auditoria()?.objetivo ? 'Editar objetivo' : 'Definir objetivo' }}
            </button>
          </div>
        } 
    
        @else {
          <div class="edit-box">
            <textarea 
              [(ngModel)]="tempObjetivo" 
              rows="4" 
              class="form-control"
              placeholder="Escribe el objetivo principal de esta auditoría..."></textarea>
            
            <div class="edit-actions">
              <button 
                class="btn btn-secondary" 
                (click)="cancelEditObjetivo()" 
                [disabled]="saving()">
                Cancelar
              </button>
              
              <button 
                class="btn btn-primary" 
                (click)="saveObjetivo()" 
                [disabled]="saving()">
                @if (saving()) { Guardando... } @else { Guardar }
              </button>
            </div>
          </div>
        }
      </div>

      <div class="info-card">
        <h3>Acciones Rápidas</h3>
        <div class="quick-actions">
          <a [routerLink]="['/auditor/evidencias']" [queryParams]="{auditoria: auditoria()!.id_auditoria}" class="btn btn-primary">
            Subir Evidencias
          </a>
          <a [routerLink]="['/auditor/reportes']" [queryParams]="{auditoria: auditoria()!.id_auditoria}" class="btn btn-secondary">
            Ver Reportes
          </a>
        </div>
      </div>
    </div>
  }
</div>

