<div class="reportes-page">
  <div class="page-header">
    <div class="header-content">
      <h2>Reportes Finales</h2>
      <p class="subtitle">Gestión y entrega de documentación oficial</p>
    </div>
    <button class="btn btn-primary" (click)="showForm.set(!showForm())">
      {{ showForm() ? 'Cancelar' : '+ Generar Reporte' }}
    </button>
  </div>

  @if (showForm()) {
    <div class="form-card slide-in">
      <div class="form-header">
        <h3>Entregar Reporte Final</h3>
        <p class="text-sm text-gray-500">
          <app-icon name="alert-triangle" [size]="14" class="text-yellow-600"></app-icon>
          Nota: Al subir el reporte, el estado de la auditoría cambiará automáticamente a <strong>FINALIZADA</strong>.
        </p>
      </div>

      <form [formGroup]="reporteForm" (ngSubmit)="onSubmit()">
        <div class="form-grid">
          
          <div class="form-group">
            <label>Seleccionar Auditoría</label>
            <select formControlName="id_auditoria">
              <option value="">-- Elige una auditoría --</option>
              @for (audit of auditoriasPendientes(); track audit.id_auditoria) {
                <option [value]="audit.id_auditoria" [disabled]="audit.id_estado === 3">
                  #{{ audit.id_auditoria }} - {{ audit.cliente?.nombre_empresa }} 
                  {{ audit.id_estado === 3 ? '(Ya Finalizada)' : '' }}
                </option>
              }
            </select>
          </div>

          <div class="form-group">
            <label>Título del Documento</label>
            <input type="text" formControlName="nombre" placeholder="Ej. Reporte de Auditoría Ambiental 2024">
          </div>

          <div class="form-group full-width">
            <label>Archivo PDF</label>
            <div class="file-upload-wrapper">
              <input 
                type="file" 
                #fileInput 
                (change)="onFileSelect($event)" 
                accept="application/pdf"
              >
              <div class="file-hint">Solo archivos .pdf (Máx 5MB)</div>
            </div>
          </div>

          <div class="form-group full-width">
            <label>Observaciones Adicionales</label>
            <textarea formControlName="observaciones" rows="3" placeholder="Comentarios finales para el cliente..."></textarea>
          </div>

        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-success" 
            [disabled]="reporteForm.invalid || !selectedFile || enviando()">
            <app-icon name="check" [size]="18" class="mr-2"></app-icon>
            {{ enviando() ? 'Subiendo...' : 'Finalizar Auditoría y Enviar' }}
          </button>
        </div>
      </form>
    </div>
  }

  @if (loading()) {
    <app-loading-spinner />
  } @else if (reportes().length === 0) {
    <app-empty-state mensaje="No has generado reportes finales aún." />
  } @else {
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Auditoría</th>
            <th>Cliente</th>
            <th>Título</th>
            <th>Archivo</th>
            <th>Fecha Entrega</th>
          </tr>
        </thead>
        <tbody>
          @for (repo of reportes(); track repo.id_reporte) {
            <tr>
              <td class="font-bold">#{{ repo.id_auditoria }}</td>
              <td>{{ repo.nombre_cliente || 'N/A' }}</td>
              <td>{{ repo.nombre }}</td>
              <td>
                <a [href]="repo.url" target="_blank" class="pdf-link">
                  <app-icon name="file-text" [size]="16"></app-icon>
                  {{ repo.nombre_archivo }}
                </a>
              </td>
              <td class="text-sm text-gray-500">{{ repo.fecha_creacion | date:'medium' }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>